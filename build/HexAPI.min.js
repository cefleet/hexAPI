var HexAPI={setup:function(a){a=a||{},this.engine=new HexAPI.Engine,this.grid=new HexAPI.Grid(a.grid)}};HexAPI.Engine=function(){this._init()},HexAPI.Engine.prototype={_init:function(){this.EVEN=1,this.ODD=-1,this._createLayout(),this._createDirections(),this._createDiagonals()},_createLayout:function(){this.LAYOUT={POINTY:this._orientation(Math.sqrt(3),Math.sqrt(3)/2,0,1.5,Math.sqrt(3)/3,-1/3,0,2/3,.5),FLAT:this._orientation(1.5,0,Math.sqrt(3)/2,Math.sqrt(3),2/3,0,-1/3,Math.sqrt(3)/3,0)}},_createDirections:function(){this.DIRECTIONS=[this._hex(1,0,-1),this._hex(1,-1,0),this._hex(0,-1,1,!0),this._hex(-1,0,1),this._hex(-1,1,0),this._hex(0,1,-1)]},_createDiagonals:function(){this.DIAGONALS=[this._hex(2,-1,-1),this._hex(1,-2,1),this._hex(-1,-1,2),this._hex(-2,1,1),this._hex(-1,2,-1),this._hex(1,1,-2)]},_hex:function(a,b,c){return{q:a,r:b,s:c}},_point:function(a,b){return{x:a,y:b}},_hexAdd:function(a,b){return this._hex(a.q+b.q,a.r+b.r,a.s+b.s)},_hexSubtract:function(a,b){return this._hex(a.q-b.q,a.r-b.r,a.s-b.s)},_hexScale:function(a,b){return this._hex(a.q*b,a.r*b,a.s*b)},_direction:function(a){return this.DIRECTIONS[a]},_diagonal:function(a){return this.DIAGONALS[a]},distanceBetween:function(a,b){return(Math.abs(a.q-b.q)+Math.abs(a.q+a.r-b.q-b.r)+Math.abs(a.r-b.r))/2},neighborAtDirection:function(a,b){return this._hexAdd(a,this._direction(b))},neighborsAtDiagonal:function(a,b){var c=this._diagonal(b);return this._hexAdd(a,c)},_orientation:function(a,b,c,d,e,f,g,h,i){return{f0:a,f1:b,f2:c,f3:d,b0:e,b1:f,b2:g,b3:h,start_angle:i}},createLayout:function(a,b,c){return c="pointy"==c?this.LAYOUT.POINTY:this.LAYOUT.FLAT,{orientation:c,hexSize:a,origin:b}},centerOfHex:function(a,b){var c=a.orientation,d=a.hexSize,e=a.origin,f=(c.f0*b.q+c.f1*b.r)*d.x,g=(c.f2*b.q+c.f3*b.r)*d.y;return this._point(f+e.x,g+e.y)},_roundToHex:function(a){var b=Math.trunc(Math.round(a.q)),c=Math.trunc(Math.round(a.r)),d=Math.trunc(Math.round(a.s)),e=Math.abs(b-a.q),f=Math.abs(c-a.r),g=Math.abs(d-a.s);return e>f&&e>g?b=-c-d:f>g?c=-b-d:d=-b-c,this._hex(b,c,d)},_cornerOffset:function(a,b){var c=a.orientation,d=a.hexSize,e=2*Math.PI*(b+c.start_angle)/6;return this._point(d.x*Math.cos(e),d.y*Math.sin(e))},cornersOfHex:function(a,b){for(var c=[],d=this.centerOfHex(a,b),e=1;6>=e;e++){l=e,6===l&&(l=0);var f=this._cornerOffset(a,e);c.push(this._point(d.x+f.x,d.y+f.y))}return c},hexAtPoint:function(a,b){var c=a.orientation,d=a.hexSize,e=a.origin,f=new this._point((b.x-e.x)/d.x,(b.y-e.y)/d.y),g=c.b0*f.x+c.b1*f.y,h=c.b2*f.x+c.b3*f.y,i=this._hex(g,h,-g-h);return this._roundToHex(i)},getHexesWithinDistance:function(a,b){for(var c=[{q:a.q,r:a.r,s:a.s}],d=1;b>=d;d++)for(var e=this.getHexesAtDistance(a,d),f=0;f<e.length;f++)c.push(e[f]);return c},getHexesAtDistance:function(a,b){for(var c=[],d=this._hexAdd(a,this._hexScale(this._direction(4),b)),e=0;6>e;e++)for(var f=0;b>f;f++)c.push(d),d=this.neighborAtDirection(d,e);return c},_hexLerp:function(a,b,c){return this._hex(a.q+(b.q-a.q)*c,a.r+(b.r-a.r)*c,a.s+(b.s-a.s)*c)},_defineLineBetweenHexes:function(a,b){for(var c=this.distanceBetween(a,b),d=[],e=1/Math.max(c,1),f=0;c>=f;f++){var g=this._hexLerp(a,b,e*f);d.push(this._roundToHex(g))}return d},checkIfLinesIntersect:function(a,b){var c,d,e,f,g,h,i,j,k,l,m,n,o,p=!1;return c=a[0].x,d=a[0].y,e=a[1].x,f=a[1].y,g=b[0].x,h=b[0].y,i=b[1].x,j=b[1].y,k=(j-h)*(e-c)-(i-g)*(f-d),0===k?p:(l=d-h,m=c-g,n=(i-g)*l-(j-h)*m,o=(e-c)*l-(f-d)*m,l=n/k,m=o/k,l>0&&1>l&&m>0&&1>m&&(p=!0),p)}},HexAPI.Grid=function(a){this._init(a)},HexAPI.Grid.prototype={_init:function(a){this.engine=HexAPI.engine,a=a||{},this.hexSize=a.hexSize||{x:30,y:30},this.origion=a.origion||{x:0,y:0},this.orientation=a.orientation||"flat",this.layout=this.engine.createLayout(this.hexSize,this.origion,this.orientation),this.rows=a.rows||30,this.cols=a.cols||20,this._createMap()},getHexAtPoint:function(a){return this.engine.hexAtPoint(this.layout,a)},_createMap:function(){this.map={};"pointy"==this.orientation?this._makePointyMap():this._makeFlatMap()},_makePointyMap:function(){for(r=0;r<this.rows;r++){var a=Math.floor(r/2);for(q=-a;q<this.cols-a;q++){var b=new HexAPI.Hex({q:q,r:r,s:-q-r,grid:this});this.map[b.id]=b}}},_makeFlatMap:function(){for(q=0;q<this.cols;q++){var a=Math.floor(q/2);for(r=-a;r<this.rows-a;r++){var b=new HexAPI.Hex({q:q,r:r,s:-q-r,grid:this});this.map[b.id]=b}}}},HexAPI.Hex=function(a){this._init(a)},HexAPI.Hex.prototype={_init:function(a){this.engine=HexAPI.engine,this.grid=a.grid||HexAPI.grid,a=a||{},this.q=a.q||0,this.r=a.r||0,this.s=a.s||0,this.id=this.q+"."+this.r+"."+this.s,this._setCenter(),this._setCorners(),this._setEdges(),this._setNeighbors(),this._setDiagonalNeighbors()},getNeighborAt:function(a){return this.neighbors[a]},getDistanceTo:function(a){return this.engine.distanceBetween(this,a)},getHexesWithinDistance:function(a){return this.engine.getHexesWithinDistance(this,a)},getHexesAtDistance:function(a){return this.engine.getHexesAtDistance(this,a)},makeHexLineTo:function(a){return this.engine._defineLineBetweenHexes(this,a)},makeStraightLineTo:function(a){return a?[this.centerPoint,a.centerPoint]:!1},getPathTo:function(a,b,c){for(var d=this._aStarGetPathTo(a,b,c),e=[],f=0;f<d.length;f++)e.push(this.grid.map[d[f].id]);return e},_aStarGetPathTo:function(a,b,c){var d;this._astarGridSetup(b,a);var e=this._aStarGrid;for(d=0;d<e.length;d++)e[d].id===this.id&&(start=e[d]),e[d].id===a.id&&(end=e[d]);var f=[];f.push(start);for(this._astarHeuristic;f.length>0;){var g=0;for(d=0;d<f.length;d++)f[d].f<f[g].f&&(g=d);var h=f[g];if(h==end){for(var i=h,j=[];i.parent;)j.push(i),i=i.parent;return j.reverse()}for(f.splice(g,1),h.closed=!0,d=0;d<h.neighbors.length;d++){var k=this._getAstarGridItemFromId(h.neighbors[d]);if(k&&!k.closed&&!k.isObstacle){var l=h.g+1,m=!1;k.visited?l<k.g&&(m=!0):(m=!0,k.h=this._astarHeuristic(k,end),k.visited=!0,f.push(k)),m&&(k.parent=h,k.g=l,k.f=k.g+k.h,k.debug="F: "+k.f+"<br />G: "+k.g+"<br />H: "+k.h)}}}return[]},_getAstarGridItemFromId:function(a){for(var b=0;b<this._aStarGrid.length;b++)if(this._aStarGrid[b].id===a)return this._aStarGrid[b]},_astarGridSetup:function(a,b){var c=[];for(var d in this.grid.map){var e=this._astartGridifyFromId(d);if(a)for(var f=0;f<a.length;f++){var g=a[f].q+"."+a[f].r+"."+a[f].s;g===e.id&&b.id!==e.id&&(e.isObstacle=!0)}c.push(e)}this._aStarGrid=c},_astartGridifyFromId:function(a){var b={};return b.id=a,b.neighbors=this.grid.map[a].neighbors,b.q=this.grid.map[a].q,b.r=this.grid.map[a].r,b.s=this.grid.map[a].s,b.f=0,b.g=0,b.h=0,b.debug="",b.parent=null,b.isObstacle=!1,b},_astarHeuristic:function(a,b){return this.engine.distanceBetween(a,b)},_setCorners:function(){this.corners=this.engine.cornersOfHex(this.grid.layout,this)},_setEdges:function(){this.edges=[],this.edges.push([this.corners[5],this.corners[0]]);for(var a=4;a>=0;a--){var b=a+1;this.edges.push([this.corners[b],this.corners[a]])}},_setCenter:function(){this.centerPoint=this.engine.centerOfHex(this.grid.layout,this)},_setNeighbors:function(){this.neighbors=[];for(var a=0;6>a;a++){var b=this.engine.neighborAtDirection(this,a);this.neighbors.push(b.q+"."+b.r+"."+b.s)}},_setDiagonalNeighbors:function(){this.diagonalNeighbors=[];for(var a=0;6>a;a++){var b=this.engine.neighborsAtDiagonal(this,a);this.diagonalNeighbors.push(b.q+"."+b.r+"."+b.s)}},_checkIfLineCrosses:function(a){for(var b=!1,c=0;c<this.edges.length;c++)if(this.edges[c]&&this.engine.checkIfLinesIntersect(a,this.edges[c])){b=!0;break}return b}};